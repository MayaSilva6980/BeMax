package com.example.bemax.ui.activity;

import android.os.Bundle;
import android.text.TextUtils;
import android.view.View;
import android.widget.FrameLayout;

import com.example.bemax.R;
import com.example.bemax.model.domain.EmergencyContact;
import com.example.bemax.model.dto.EmergencyContactRequest;
import com.example.bemax.network.repository.EmergencyContactRepository;
import com.example.bemax.ui.base.BaseActivity;
import com.example.bemax.util.helper.InputMaskHelper;
import com.example.bemax.util.helper.NotificationHelper;
import com.example.bemax.util.security.TokenManager;
import com.google.android.material.appbar.MaterialToolbar;
import com.google.android.material.button.MaterialButton;
import com.google.android.material.textfield.TextInputEditText;
import com.google.android.material.textfield.TextInputLayout;

public class EmergencyContactFormActivity extends BaseActivity {
    private static final String TAG = "ContactForm";

    private MaterialToolbar toolbar;
    private TextInputLayout layoutContactName, layoutRelationship, layoutPhone, layoutEmail, layoutNotes;
    private TextInputEditText edtContactName, edtRelationship, edtPhone, edtEmail, edtNotes;
    private MaterialButton btnSave;
    private FrameLayout progressOverlay;

    private EmergencyContactRepository repository;
    private TokenManager tokenManager;
    private EmergencyContact contactToEdit;
    private boolean isEditMode = false;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_emergency_contact_form);

        repository = new EmergencyContactRepository();
        tokenManager = TokenManager.getInstance(this);
        tokenManager.setBiometricManager(this);

        obtainParameters();
        initializeControls();
        loadData();
    }

    @Override
    protected void obtainParameters() {
        if (getIntent().hasExtra("contact")) {
            contactToEdit = (EmergencyContact) getIntent().getSerializableExtra("contact");
            isEditMode = contactToEdit != null;
        }
    }

    @Override
    protected void initializeControls() {
        toolbar = findViewById(R.id.toolbar);
        layoutContactName = findViewById(R.id.layoutContactName);
        layoutRelationship = findViewById(R.id.layoutRelationship);
        layoutPhone = findViewById(R.id.layoutPhone);
        layoutEmail = findViewById(R.id.layoutEmail);
        layoutNotes = findViewById(R.id.layoutNotes);
        edtContactName = findViewById(R.id.edtContactName);
        edtRelationship = findViewById(R.id.edtRelationship);
        edtPhone = findViewById(R.id.edtPhone);
        edtEmail = findViewById(R.id.edtEmail);
        edtNotes = findViewById(R.id.edtNotes);
        btnSave = findViewById(R.id.btnSave);
        progressOverlay = findViewById(R.id.progressOverlay);

        toolbar.setTitle(isEditMode ? R.string.emergency_contact_edit : R.string.emergency_contact_add);
        toolbar.setNavigationOnClickListener(v -> finish());

        // Add phone mask
        InputMaskHelper.addPhoneMask(edtPhone);

        btnSave.setOnClickListener(v -> saveContact());
    }

    @Override
    protected void loadData() {
        if (isEditMode && contactToEdit != null) {
            edtContactName.setText(contactToEdit.getName());
            edtRelationship.setText(contactToEdit.getRelationship());
            edtPhone.setText(contactToEdit.getPhone());
            edtEmail.setText(contactToEdit.getEmail());
            edtNotes.setText(contactToEdit.getNotes());
        }
    }

    private void saveContact() {
        if (!validateForm()) return;

        String name = edtContactName.getText().toString().trim();
        String relationship = edtRelationship.getText().toString().trim();
        String phone = edtPhone.getText().toString().trim();
        String email = edtEmail.getText().toString().trim();
        String notes = edtNotes.getText().toString().trim();

        EmergencyContactRequest request = new EmergencyContactRequest(name, relationship, phone, 
            email.isEmpty() ? null : email, notes.isEmpty() ? null : notes);

        showLoading();
        tokenManager.getAccessToken(new TokenManager.TokenCallback() {
            @Override
            public void onSuccess(String token) {
                if (isEditMode) {
                    updateContact(token, request);
                } else {
                    createContact(token, request);
                }
            }

            @Override
            public void onError(String error) {
                runOnUiThread(() -> {
                    hideLoading();
                    NotificationHelper.showError(EmergencyContactFormActivity.this, error);
                });
            }
        });
    }

    private void createContact(String token, EmergencyContactRequest request) {
        repository.createEmergencyContact(token, request, 
            new EmergencyContactRepository.OnContactSavedCallback() {
            @Override
            public void onSuccess(EmergencyContact contact) {
                runOnUiThread(() -> {
                    hideLoading();
                    NotificationHelper.showSuccess(EmergencyContactFormActivity.this, 
                        getString(R.string.contact_created_success));
                    setResult(RESULT_OK);
                    finish();
                });
            }

            @Override
            public void onError(String errorMsg) {
                runOnUiThread(() -> {
                    hideLoading();
                    NotificationHelper.showError(EmergencyContactFormActivity.this, 
                        getString(R.string.contact_create_error));
                });
            }
        });
    }

    private void updateContact(String token, EmergencyContactRequest request) {
        repository.updateEmergencyContact(token, contactToEdit.getId(), request, 
            new EmergencyContactRepository.OnContactSavedCallback() {
            @Override
            public void onSuccess(EmergencyContact contact) {
                runOnUiThread(() -> {
                    hideLoading();
                    NotificationHelper.showSuccess(EmergencyContactFormActivity.this, 
                        getString(R.string.contact_updated_success));
                    setResult(RESULT_OK);
                    finish();
                });
            }

            @Override
            public void onError(String errorMsg) {
                runOnUiThread(() -> {
                    hideLoading();
                    NotificationHelper.showError(EmergencyContactFormActivity.this, 
                        getString(R.string.contact_update_error));
                });
            }
        });
    }

    private boolean validateForm() {
        boolean isValid = true;

        String name = edtContactName.getText().toString().trim();
        if (TextUtils.isEmpty(name)) {
            layoutContactName.setError(getString(R.string.error_contact_name_required));
            isValid = false;
        } else {
            layoutContactName.setError(null);
        }

        String relationship = edtRelationship.getText().toString().trim();
        if (TextUtils.isEmpty(relationship)) {
            layoutRelationship.setError(getString(R.string.error_contact_relationship_required));
            isValid = false;
        } else {
            layoutRelationship.setError(null);
        }

        String phone = edtPhone.getText().toString().trim();
        if (TextUtils.isEmpty(phone)) {
            layoutPhone.setError(getString(R.string.error_contact_phone_required));
            isValid = false;
        } else if (phone.replaceAll("[^\\d]", "").length() < 10) {
            layoutPhone.setError(getString(R.string.error_contact_phone_invalid));
            isValid = false;
        } else {
            layoutPhone.setError(null);
        }

        return isValid;
    }

    private void showLoading() {
        progressOverlay.setVisibility(View.VISIBLE);
        btnSave.setEnabled(false);
    }

    private void hideLoading() {
        progressOverlay.setVisibility(View.GONE);
        btnSave.setEnabled(true);
    }
}

